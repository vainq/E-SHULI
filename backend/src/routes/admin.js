const{Router}=require('express');const crypto=require('crypto');const jwt=require('jsonwebtoken');const{CONFIG}=require('../config');const AdminSession=require('../models/AdminSession');const{sendOTP}=require('../mailer');const r=Router();const hash=otp=>crypto.createHash('sha256').update(otp).digest('hex');r.post('/login',async(req,res)=>{const{username,password}=req.body||{};if(username!==CONFIG.ADMIN_USERNAME||password!==CONFIG.ADMIN_PASSWORD){return res.status(401).json({error:'Invalid credentials'});}const otp=String(Math.floor(100000+Math.random()*900000));const otpHash=hash(otp);const otpExpires=new Date(Date.now()+10*60*1000);await AdminSession.create({username,otpHash,otpExpires,verified:false});await sendOTP(CONFIG.ADMIN_EMAIL,otp);res.json({message:'OTP sent to admin email'});});r.post('/verify',async(req,res)=>{const{username,otp}=req.body||{};const s=await AdminSession.findOne({username}).sort({createdAt:-1});if(!s)return res.status(400).json({error:'No session'});if(s.verified)return res.status(400).json({error:'Already verified'});if(s.otpExpires<new Date())return res.status(400).json({error:'OTP expired'});if(s.otpHash!==hash(otp))return res.status(400).json({error:'Invalid OTP'});s.verified=true;await s.save();const token=jwt.sign({sub:username,role:'admin'},CONFIG.JWT_SECRET,{expiresIn:'12h'});res.json({token});});module.exports=r;
