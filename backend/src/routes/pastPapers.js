const{Router}=require('express');const PastPaper=require('../models/PastPaper');const{requireAuth}=require('../middleware/auth');const refresh=require('../jobs/scrapePastPapers');const r=Router();r.get('/',async(req,res)=>{const{search,level,year,source,page='1',limit='20'}=req.query;const q={};if(search)q.title={$regex:search,$options:'i'};if(level)q.level=level;if(year)q.year=+year;if(source)q.source=source;const p=Math.max(parseInt(page),1);const l=Math.max(parseInt(limit),1);const[items,total]=await Promise.all([PastPaper.find(q).sort({year:-1,subject:1}).skip((p-1)*l).limit(l),PastPaper.countDocuments(q)]);res.json({items,total,page:p,pages:Math.ceil(total/l)});});r.post('/',requireAuth,async(req,res)=>{const created=await PastPaper.create(req.body);res.json(created);});r.post('/refresh',requireAuth,async(_req,res)=>{const n=await refresh();res.json({refreshed:n});});module.exports=r;
