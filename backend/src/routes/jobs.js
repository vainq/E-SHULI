const{Router}=require('express');const Job=require('../models/Job');const{requireAuth}=require('../middleware/auth');const refresh=require('../jobs/fetchJobs');const r=Router();r.get('/',async(req,res)=>{const{search,page='1',limit='20'}=req.query;const q={};if(search){q.$or=[{title:{$regex:search,$options:'i'}},{description:{$regex:search,$options:'i'}}];}const p=Math.max(parseInt(page),1);const l=Math.max(parseInt(limit),1);const[items,total]=await Promise.all([Job.find(q).sort({postedAt:-1,createdAt:-1}).skip((p-1)*l).limit(l),Job.countDocuments(q)]);res.json({items,total,page:p,pages:Math.ceil(total/l)});});r.post('/refresh',requireAuth,async(_req,res)=>{const n=await refresh();res.json({refreshed:n});});module.exports=r;
